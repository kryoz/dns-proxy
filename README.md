# DNS Proxy —Å Primary/Fallback –ª–æ–≥–∏–∫–æ–π –∏ eBPF-like —Å–∫–æ—Ä–∏–Ω–≥–æ–º

[üá¨üáß English version](README.en.md)

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π DNS-–ø—Ä–æ–∫—Å–∏, –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–π –Ω–∞ Go, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞ —Ä–æ—É—Ç–µ—Ä–∞—Ö (–≤ —Ç.—á. aarch64) –∏ –æ–±—ã—á–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö.  
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π DNS-—Å–µ—Ä–≤–µ—Ä, fallback-—Å–µ—Ä–≤–µ—Ä—ã, —ç–≤—Ä–∏—Å—Ç–∏–∫—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏, –∞ —Ç–∞–∫–∂–µ eBPF-–ø–æ–¥–æ–±–Ω—ã–π scoring –∞–ª–≥–æ—Ä–∏—Ç–º, –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π AdGuard Home (—Ñ–æ—Ä–º—É–ª–∞ ‚Ññ1: RTT + penalty + decay).

---

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –ü—Ä–∏—ë–º DNS-–∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ UDP –Ω–∞ –ø–æ—Ä—Ç—É 53
- –ü—Ä–æ–∫—Å–∏-–ø–µ—Ä–µ–¥–∞—á–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ **–æ—Å–Ω–æ–≤–Ω–æ–π DNS-—Å–µ—Ä–≤–µ—Ä**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ fallback-—Ä–µ–∂–∏–º –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ DNS
- TTL –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è *primary down* (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 –º–∏–Ω—É—Ç)
- –ù–µ—Å–∫–æ–ª—å–∫–æ fallback-—Å–µ—Ä–≤–µ—Ä–æ–≤
- –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–æ–∫ –Ω–∞ fallback-—Å–µ—Ä–≤–µ—Ä—ã:
    - –ù–∞ –æ—Å–Ω–æ–≤–µ –∏—Ö –∑–∞–¥–µ—Ä–∂–µ–∫ (RTT)
    - –° –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **eBPF-–ø–æ–¥–æ–±–Ω–æ–≥–æ scoring**:  
      `score = RTT * decay + penalty_on_fail`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –≤–µ—Å–æ–≤ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ atomic-–æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ PID-—Ñ–∞–π–ª–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª
- –ö—Ä–æ—Å—Å-–∫–æ–º–ø–∏–ª—è—Ü–∏—è –¥–ª—è Linux/aarch64

### üîß –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç eBPF-–ø–æ–¥–æ–±–Ω—ã–π scoring

–ö–∞–∂–¥–æ–º—É fallback-—Å–µ—Ä–≤–µ—Ä—É –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π score.
–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ DNS-–∑–∞–ø—Ä–æ—Å–∞ score –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ —Ñ–æ—Ä–º—É–ª–µ:

```
score = score * decay + rtt + penalty(on_failure)
```

* decay ‚Äî –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
* rtt ‚Äî —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
* penalty ‚Äî —à—Ç—Ä–∞—Ñ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

–í—ã–±–∏—Ä–∞–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä **—Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º** score.

---

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –°–±–æ—Ä–∫–∞
```bash
go build ./cmd/dns-proxy
```

### –ö—Ä–æ—Å—Å-–∫–æ–º–ø–∏–ª—è—Ü–∏—è
```bash
GOOS=linux GOARCH=arm64 go build -o dns-proxy ./cmd/dns-proxy
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

* –ü—Ä–∏–º–µ—Ä [config.yaml](config.yaml.example)
* –ü—Ä–æ–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ –≤ Keenetic [/opt/etc/init.d/S99dnsproxy](keenetic/opt/etc/init.d/S99dnsproxy)

## ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫
```bash
./dns-proxy --config config.yaml --pid /var/run/dns-proxy.pid --log /var/log/dns-proxy.log
```